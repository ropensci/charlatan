---
title: "Contributing to charlatan"
author: "Scott Chamberlain & Roel Hogervorst"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: readable
vignette: >
  %\VignetteIndexEntry{Contributing to charlatan}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r echo=FALSE}
knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  warning = FALSE,
  message = FALSE
)
```

`charlatan` is a wee bit complex. This vignette aims to help you contribute
to the package. For a general introduction on contributing to rOpenSci packages
see our [Contributing guide](https://devguide.ropensci.org/contributingguide.html).

Let's start with some definitions.

## Definitions

For the purposes of this package:

* **Provider**: a type of data that can be generated in `charlatan`. For example,
we have providers for phone numbers, addresses and people's names. Adding a provider
may involve a single file, more than one file; and a single R6 class or many
R6 classes.
* **Locale**: a locale for our purposes is a specific spoken language that's
associated with a specific country. You can have more than one locale for a
given language (e.g., `en-US`, `en-GB`). Some fakers won't have any locales,
whereas others can have many.

So we have the Provider: `AddressProvider` with locale `en_US` that makes the
provider `AddressProvider_en_US`

If you aren't familiar with R6, have a look at the
[R6 website](https://r6.r-lib.org/), in particular the
[introductory vignette](https://r6.r-lib.org/articles/Introduction.html).

## Communication

Open an issue if you want to add a new provider or locale to
an existing provider; it helps make sure there's no duplicated effort and
we can help make sure you have the knowledge you need.

## Adding a new provider

Providers are created by making an R6 class. Let's start with a
heavily simplified base R6 class that defines some utility methods. We
call it `BaseProvider` in `charlatan`, but here we'll call it `MyBaseProvider`
to avoid confusion.

```{r}
library(R6)
MyBaseProvider <- R6::R6Class(
  "MyBaseProvider",
  public = list(
    random_element = function(x) {
      if (length(x) == 0) {
        return("")
      }
      if (inherits(x, "character")) {
        if (!any(nzchar(x))) {
          return("")
        }
      }
      x[sample.int(n = length(x), size = 1)]
    },
    random_int = function(min = 0, max = 9999, size = 1) {
      stopifnot(max >= min)
      num <- max - min + 1
      sample.int(n = num, size = size, replace = TRUE) + (min - 1)
    }
  )
)
```

# Guidelines for providers and locales

It is vital that we provide enough information.

## Inheritance
At the heart of charlatan is the `BareProvider`, this class
has all the basic number and text substitution that is used
throughout the the package. All Providers with locales
use the `BaseProvider` which inherits all the functionality from
the BaseProvider and adds locale logic.

All providers inherit from either BaseProvider or  BareProvider; `AddressProvider` for instance, inherits from the `BaseProvider`.


## Where should I add logic or data?
**New localized provider**: If you add a new locale of a provider (f.i. klingon, LoremIpsum): 
create a new  class that inherits from the baseprovider _in this case LoremProvider_. 

TODO: USE THE TEMPLATE FILE (in inst/) TO EASILY ADD A NEW LOCALE SPECIFIC VERSION. 

TODO: THIS DOESN'T WORK ANYMORE
use describein to inherit the docs.

```r
lorem_word_list_tlh <- c("'Igh'aDmegh", "DIron", "Da'lar","moQbID")

#' @describeIn {LoremProvider} {Klingon (Klingon)}
LoremProvider_tlh <- R6::R6Class(
  inherit = LoremProvider,
  "LoremProvider_tlh",
  public = list(
    locale = "tlh"
  ),
  private = list(
    word_list = lorem_word_list_tlh
  )
)

```

**New provider without locale**: Add enough information on how to use 
the provider in the examples. 

```r
#' @title NewProvider
#' @description a description
#' @export
#' @details more details
#' @examples
#' # examples here
NewProvider <- R6::R6Class(
  "NewProvider",
  inherit = BareProvider,
  public = list(
  
  # add functionality here
  
))
```


**new provider with locale**: make sure you describe here the generic
and create at least the en_US version. 

The base localized providers have locale = NULL.
```r
#' @title NewProvider
#' @description a description
#' @export
#' @details more details
#' @examples
#' # examples here
NewProvider <- R6::R6Class(
  "NewProvider",
  inherit = BaseProvider,
  public = list(
    #' @field locale (character) the locale
    locale = NULL
    
    # Add new functionality here
    
    )
    )
    
#' @describeIn {NewProvider} {English (United states)} 
NewProvider_en_US <- R6::R6Class(
  "NewProvider",
  inherit = NewProvider,
  public = list(
    #' @field locale (character) the locale
    locale = "en_US"
    
    # Add new functionality here
    
    )
    )

```




# thing

### Providers without locale support

If you don't need to handle locales it becomes simpler:


```{r}
# TODO: this should prob use BareProvider
FooBar <- R6::R6Class(
  "FooBar",
  inherit = charlatan::BaseProvider,
  public = list(
    integer = function(n = 1, min = 1, max = 1000) {
      super$random_int(min, max, n)
    }
  )
)
```

We can create an instance of the `FooBar` class by calling `$new()` on it.
It only has one method `integer()`, which we can call to get a random
integer.

```{r}
x <- FooBar$new()
x
x$integer()
```

### Providers with locale support

If your provider will need to handle different locales, it gets a bit more
complex. In the Python library [faker][] from which this package draws
inspiration, you can create separate folders for each provider within the
Python library.

However, R doesn't allow this, so instead we categorize different locales for
each provider within the file names. For example, for the address provider we
have files in the package:

- [address-provider.R](https://github.com/ropensci/charlatan/blob/master/R/address-provider.R)
- [address-provider-en_US.R](https://github.com/ropensci/charlatan/blob/master/R/address-provider-en_US.R)
- [address-provider-en_GB.R](https://github.com/ropensci/charlatan/blob/master/R/address-provider-en_GB.R)

Where the latter two provides specific classes for each locale, and the first
file has the base `AddressProvider` class that is inherited by the locale specific class.

Here, we'll create a very simplified localized `AddressProvider` class using an
template file.

```{r}
library(charlatan)
file <- system.file("examples", "address-provider-template", package = "charlatan")
source(file)
```

If you want to add a locale specific provider you must add a new class. 
The localized address provider inherits from the Addressprovider and must
provide the functions that are in the template, but you have freedom to 
create specifics that are necesssary for your locale. 

```r
AddressProvider_template <- R6::R6Class(
    inherit = AddressProvider,
    "AddressProvider_template",
    lock_objects = FALSE,
    public = list(
        # add your data here
        
        
        # Fill in these functions
        #' @description address
        address = function(){
            # override this required function 
        },
        #' @description city
        city = function() {
            # override this required function
        },
        #' @description street name
        street_name = function() {
            # override this required function
        },
        #' @description street address
        street_address = function() {
            # override this required function
        },
        #' @description postal code
        postcode = function() {
            # override this required function
        }
        # Add more functions if you like, that is what makes 
        # the class inheritance so useful
    )
)

```
TODO: make this an example like spongebob squarepants? 

```
124 Conch Street, Bikini Bottom, Pacific Ocean
```

Something like needs to be a fruit in English, street is always something like bottom, below, or sea related

We can create an instance of the `MyAddressProvider` class by calling `$new()` on it.
It only has one method `city_suffix()`, which we can call to get a random
city suffix.

```{r}
x <- MyAddressProvider$new()
x
x$city_suffix()
```

#### Adding a new locale

When you want to add a new locale to an existing provider, look in the `R/` folder
of the package and the locales that are available are in the file names.

Pick one of the locale files for the provider you're extending, make a duplicate of it
and rename the file with your new locale. Then modify the duplicate, copying the
format but putting in place the appropriate information for the new locale.

Where the data comes from for the new locale may vary. One easy way to start may be
porting over locales in the [faker][] Python library that are not yet in `charlatan`.

If it's a locale for which you can't easily port over from another library, you need
to get the data from a variety of sources. There are some R based packages that
should help:

- [WikidataR][]
- [humaniformat][]
- [WikidataQueryServiceR][]

Keep in mind when using data to look at their license, if any, and any implications
with respect to whether it can be used in this package.


## How locale specific data are used in providers
TODO: this no longer works like this.
It's a little tricky how this is done. In the `initialize()` block of each main provider
file (e.g., `address-provider.R`) we pull in the appropriate locale specific data
based on the user input locale. For example, here's an abbreviated `initialize` block from
the `AddressProvider`:

```r
initialize = function(locale = NULL) {
  if (!is.null(locale)) {
    # check global locales
    super$check_locale(locale)
    # check address provider locales
    check_locale_(locale, address_provider_locales)
    self$locale <- locale
  } else {
    self$locale <- 'en_US'
  }

  self$city_prefixes <- parse_eval("city_prefixes_", self$locale)
}
```

A few things to note:

* if no locale is given, we by default use `en_US`
* we check that the locale given is in the allowed set
 


[faker]: https://github.com/joke2k/faker
[humaniformat]: https://github.com/Ironholds/humaniformat
[WikidataQueryServiceR]: https://cran.r-project.org/package=WikidataQueryServiceR
[WikidataR]: https://cran.r-project.org/package=WikidataR
